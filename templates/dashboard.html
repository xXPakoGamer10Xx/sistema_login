{% extends "base.html" %}

{% block title %}Dashboard - Sistema Académico{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4 dashboard-header">
            <h2>
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
            </h2>
            <span class="badge bg-primary fs-6">{{ current_user.get_rol_display() }}</span>
        </div>
    </div>
</div>

<!-- Estadísticas Rápidas -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Estadísticas Rápidas
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-primary mb-1">{{ user_count }}</h3>
                            <p class="text-muted mb-0 small">Usuarios Totales</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-success mb-1">{{ admin_count }}</h3>
                            <p class="text-muted mb-0 small">Administradores</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h3 class="text-warning mb-1">{{ jefe_count }}</h3>
                            <p class="text-muted mb-0 small">Jefes de Carrera</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info mb-1">{{ profesor_count }}</h3>
                        <p class="text-muted mb-0 small">Profesores</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Información del usuario -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    Mi Información
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    {% if current_user.get_imagen_perfil_url() %}
                        <img src="{{ current_user.get_imagen_perfil_url() }}" 
                             alt="Imagen de perfil" 
                             class="rounded-circle profile-avatar">
                    {% else %}
                        <i class="fas fa-user-circle fa-4x text-primary"></i>
                    {% endif %}
                    
                    <!-- Formulario para subir imagen -->
                    <div class="mt-3">
                        <form action="{{ url_for('subir_imagen_perfil') }}" method="post" enctype="multipart/form-data" class="d-inline">
                            <div class="input-group">
                                    <input type="file" class="d-none" id="imagen_perfil" name="imagen_perfil" 
                                        accept="image/*" onchange="this.form.submit()">
                                <label for="imagen_perfil" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-camera me-1"></i>
                                    {% if current_user.get_imagen_perfil_url() %}
                                        Cambiar Foto
                                    {% else %}
                                        Subir Foto
                                    {% endif %}
                                </label>
                            </div>
                        </form>
                        {% if current_user.get_imagen_perfil_url() %}
                            <button class="btn btn-outline-danger btn-sm ms-1" onclick="eliminarImagenPerfil()">
                                <i class="fas fa-trash me-1"></i>
                                Eliminar
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Sección Firma Digital -->
                <div class="border-top pt-3 mt-3">
                    <h6 class="text-center mb-3">
                        <i class="fas fa-signature me-1"></i>Mi Firma Digital
                    </h6>
                    <div class="text-center">
                        {% if current_user.get_firma_url() %}
                            <img src="{{ current_user.get_firma_url() }}"
                                 alt="Firma digital"
                                 class="img-fluid mb-2 profile-signature-preview">
                        {% else %}
                            <p class="text-muted small mb-2">
                                <i class="fas fa-pen-fancy me-1"></i>Sin firma registrada
                            </p>
                        {% endif %}

                        <div class="mt-2">
                            <!-- Botón para abrir modal de dibujar firma -->
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="abrirModalFirma()">
                                <i class="fas fa-pen me-1"></i>
                                Dibujar Firma
                            </button>

                            <!-- Botón para subir imagen de firma -->
                            <form action="{{ url_for('subir_firma') }}" method="post" enctype="multipart/form-data" class="d-inline">
                                    <input type="file" class="d-none" id="firma" name="firma"
                                        accept="image/*" onchange="this.form.submit()">
                                <label for="firma" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-upload me-1"></i>
                                    Subir Imagen
                                </label>
                            </form>
                            {% if current_user.get_firma_url() %}
                                <button class="btn btn-outline-danger btn-sm ms-1" onclick="eliminarFirma()">
                                    <i class="fas fa-trash me-1"></i>
                                    Eliminar
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <table class="table table-borderless">
                    <tr>
                        <td><strong>Nombre:</strong></td>
                        <td>{{ current_user.get_nombre_completo() }}</td>
                    </tr>
                    <tr>
                        <td><strong>Usuario:</strong></td>
                        <td>{{ current_user.username }}</td>
                    </tr>
                    <tr>
                        <td><strong>Email:</strong></td>
                        <td>{{ current_user.email }}</td>
                    </tr>
                    {% if current_user.telefono %}
                    <tr>
                        <td><strong>Teléfono:</strong></td>
                        <td>{{ current_user.telefono }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>Rol:</strong></td>
                        <td>{{ current_user.get_rol_display() }}</td>
                    </tr>
                    {% if current_user.is_jefe_carrera() and current_user.carreras %}
                    <tr>
                        <td><strong>Carrera(s):</strong></td>
                        <td>
                            {% for carrera in current_user.carreras %}
                            <span class="badge bg-success me-1">{{ carrera.nombre }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Código(s):</strong></td>
                        <td>{{ current_user.carreras|map(attribute='codigo')|join(', ') }}</td>
                    </tr>
                    {% endif %}
                    {% if current_user.is_profesor() %}
                    <tr>
                        <td><strong>Tipo:</strong></td>
                        <td>{{ current_user.get_tipo_profesor_display() }}</td>
                    </tr>
                    {% if current_user.carreras %}
                    <tr>
                        <td><strong>Carrera(s):</strong></td>
                        <td>
                            {% for carrera in current_user.carreras %}
                            <span class="badge bg-info me-1">{{ carrera.nombre }}</span>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endif %}
                    <tr>
                        <td><strong>Registro:</strong></td>
                        <td>{{ current_user.fecha_registro.strftime('%d/%m/%Y') }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- Opciones según el rol -->
    <div class="col-md-8 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Opciones Disponibles
                </h5>
            </div>
            <div class="card-body">
                {% if current_user.is_admin() %}
                    <!-- Sección de Administrador -->
                    <div class="mb-4">
                        <h6 class="text-muted border-bottom pb-2 mb-3">
                            <i class="fas fa-shield-alt me-2"></i>Panel de Administrador
                        </h6>
                        <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-2x text-primary mb-2"></i>
                                    <h6>Gestión de Usuarios</h6>
                                    <p class="small text-muted">Administrar todos los usuarios del sistema</p>
                                    <a href="{{ url_for('gestionar_usuarios') }}" class="btn btn-primary btn-sm">Acceder</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-success mb-2"></i>
                                    <h6>Gestión de Horarios</h6>
                                    <p class="small text-muted">Configurar horarios matutino y vespertino</p>
                                    <a href="{{ url_for('gestionar_horarios') }}" class="btn btn-success btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-chalkboard-teacher fa-2x text-info mb-2"></i>
                                    <h6>Gestión de Profesores</h6>
                                    <p class="small text-muted">Administrar profesores y sus asignaciones</p>
                                    <a href="{{ url_for('gestionar_profesores') }}" class="btn btn-info btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-purple">
                                <div class="card-body text-center">
                                    <i class="fas fa-graduation-cap fa-2x text-purple mb-2"></i>
                                    <h6>Gestión de Carreras</h6>
                                    <p class="small text-muted">Administrar carreras y programas académicos</p>
                                    <a href="{{ url_for('gestionar_carreras') }}" class="btn btn-purple btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <i class="fas fa-book fa-2x text-secondary mb-2"></i>
                                    <h6>Gestión de Materias</h6>
                                    <p class="small text-muted">Administrar materias por cuatrimestre y carrera</p>
                                    <a href="{{ url_for('gestionar_materias') }}" class="btn btn-secondary btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                                    <h6>Gestión de Grupos</h6>
                                    <p class="small text-muted">Administrar grupos académicos y asignar materias</p>
                                    <a href="{{ url_for('gestionar_grupos') }}" class="btn btn-info btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <i class="fas fa-tasks fa-2x text-danger mb-2"></i>
                                    <h6>Asignación Masiva de Materias</h6>
                                    <p class="small text-muted">Asignar materias a múltiples profesores</p>
                                    <a href="{{ url_for('asignacion_masiva_materias') }}" class="btn btn-danger btn-sm">Asignar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                                    <h6>Reportes del Sistema</h6>
                                    <p class="small text-muted">Ver estadísticas y reportes generales</p>
                                    <a href="{{ url_for('reportes_sistema') }}" class="btn btn-warning btn-sm">Ver Reportes</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                                    <div class="card border-primary">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-clock fa-2x text-primary mb-2"></i>
                                            <h6>Horarios por Profesor</h6>
                                            <p class="small text-muted">Consultar horario de cada profesor</p>
                                            <a href="{{ url_for('admin_horario_profesores') }}" class="btn btn-primary btn-sm">Consultar</a>
                                        </div>
                                    </div>
                                </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-2x text-success mb-2"></i>

                                    <h6>Horarios por Grupo</h6>
                                    <p class="small text-muted">Consultar horario de cada grupo</p>
                                    <a href="{{ url_for('admin_horario_grupos') }}" class="btn btn-success btn-sm">Consultar</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-check fa-2x text-warning mb-2"></i>
                                    <h6>Disponibilidad de Profesores</h6>
                                    <p class="small text-muted">Gestionar disponibilidad horaria de profesores</p>
                                    <a href="{{ url_for('admin_disponibilidad_profesores') }}" class="btn btn-warning btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-dark">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-alt fa-2x text-dark mb-2"></i>
                                    <h6>Horarios Académicos</h6>
                                    <p class="small text-muted">Generar y gestionar horarios de clases</p>
                                    <a href="{{ url_for('gestionar_horarios_academicos') }}" class="btn btn-dark btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-cog fa-2x text-info mb-2"></i>
                                    <h6>Configuración</h6>
                                    <p class="small text-muted">Configurar parámetros del sistema</p>
                                    <a href="{{ url_for('configuracion_sistema') }}" class="btn btn-info btn-sm">Configurar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <i class="fas fa-history fa-2x text-secondary mb-2"></i>
                                    <h6>Historial Versiones</h6>
                                    <p class="small text-muted">Backups de horarios de todas las carreras</p>
                                    <a href="{{ url_for('listar_versiones_admin') }}" class="btn btn-outline-secondary btn-sm">Ver</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                {% endif %}
                
                {% if current_user.is_jefe_carrera() %}
                    <!-- Sección de Jefe de Carrera -->
                    <div class="mb-4">
                        <h6 class="text-muted border-bottom pb-2 mb-3 panel-role-title">
                            <i class="fas fa-user-tie me-2"></i>Panel de Jefe de Carrera
                            {% if current_user.carreras %}
                            <span class="badge bg-success ms-2 badge-responsive">{{ current_user.carreras|map(attribute='nombre')|join(', ') }}</span>
                            {% endif %}
                        </h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <i class="fas fa-chalkboard-teacher fa-2x text-primary mb-2"></i>
                                    <h6>Gestión de Profesores</h6>
                                    <p class="small text-muted">Administrar profesores de la carrera</p>
                                    <a href="{{ url_for('gestionar_profesores_jefe') }}" class="btn btn-primary btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-book fa-2x text-success mb-2"></i>
                                    <h6>Plan de Estudios</h6>
                                    <p class="small text-muted">Revisar y modificar plan de estudios</p>
                                    <a href="{{ url_for('gestionar_materias_jefe') }}" class="btn btn-success btn-sm">Ver Plan</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-alt fa-2x text-warning mb-2"></i>
                                    <h6>Horarios Académicos</h6>
                                    <p class="small text-muted">Gestionar horarios de clases</p>
                                    <a href="{{ url_for('gestionar_horarios_academicos_jefe') }}" class="btn btn-warning btn-sm">Horarios</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                                    <h6>Gestión de Grupos</h6>
                                    <p class="small text-muted">Administrar grupos académicos de tu carrera</p>
                                    <a href="{{ url_for('gestionar_grupos') }}" class="btn btn-info btn-sm">Gestionar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <i class="fas fa-tasks fa-2x text-danger mb-2"></i>
                                    <h6>Asignación Masiva de Materias</h6>
                                    <p class="small text-muted">Asignar materias a múltiples profesores</p>
                                    <a href="{{ url_for('asignacion_masiva_materias_jefe') }}" class="btn btn-danger btn-sm">Asignar</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
    <div class="card border-primary">
        <div class="card-body text-center">
            <i class="fas fa-user-clock fa-2x text-primary mb-2"></i>
            
            <h6>Horarios de Profesores</h6>
            <p class="small text-muted">Ver horarios de los profesores de tu carrera</p>
            <a href="{{ url_for('jefe_ver_horarios_profesores') }}" class="btn btn-primary btn-sm">Consultar</a>
        </div>
    </div>
</div>

<div class="col-md-6 mb-3">
    <div class="card border-success">
        <div class="card-body text-center">
            <i class="fas fa-list-alt fa-2x text-success mb-2"></i>
            
            <h6>Horarios por Grupo/Materia</h6>
            <p class="small text-muted">Ver horarios de las materias de tu carrera</p>
            <a href="{{ url_for('jefe_ver_horarios_grupos') }}" class="btn btn-success btn-sm">Consultar</a>
        </div>
    </div>
</div>

<div class="col-md-6 mb-3">
    <div class="card border-warning">
        <div class="card-body text-center">
            <i class="fas fa-calendar-check fa-2x text-warning mb-2"></i>
            <h6>Disponibilidad de Profesores</h6>
            <p class="small text-muted">Gestionar disponibilidad horaria de profesores</p>
            <a href="{{ url_for('disponibilidad_profesores_jefe') }}" class="btn btn-warning btn-sm">Gestionar</a>
        </div>
    </div>
</div>
                        </div>
                        
                        <!-- Sección de Generación de Horarios -->
                        <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">
                            <i class="fas fa-magic me-2 text-danger"></i>Generación de Horarios
                        </h6>
                        <div class="row justify-content-center">
                            <div class="col-md-4 mb-3">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <i class="fas fa-layer-group fa-2x text-danger mb-2"></i>
                                        <h6>Generar Horarios</h6>
                                        <p class="small text-muted">Generar múltiples grupos</p>
                                        <a href="{{ url_for('generar_horarios_masivo_jefe') }}" class="btn btn-danger btn-sm">Generar</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="card border-secondary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-history fa-2x text-secondary mb-2"></i>
                                        <h6>Historial Versiones</h6>
                                        <p class="small text-muted">Backups y restauración</p>
                                        <a href="{{ url_for('listar_versiones_jefe') }}" class="btn btn-outline-secondary btn-sm">Ver</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                {% endif %}
                
                {% if current_user.is_profesor() %}
                    <!-- Sección de Profesor -->
                    <div class="mb-4">
                        <h6 class="text-muted border-bottom pb-2 mb-3">
                            <i class="fas fa-chalkboard-teacher me-2"></i>Panel de Profesor
                            <span class="badge bg-info ms-2">{{ current_user.get_tipo_profesor_display() }}</span>
                        </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <i class="fas fa-calendar-alt fa-2x text-success mb-2"></i>
                                    <h6>Mis Horarios</h6>
                                    <p class="small text-muted">Ver mis horarios y materias asignadas</p>
                                    <a href="{{ url_for('profesor_horarios') }}" class="btn btn-success btn-sm">Ver Horarios</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                                    <h6>Mi Disponibilidad</h6>
                                    <p class="small text-muted">Ver y gestionar mi disponibilidad horaria</p>
                                    <a href="{{ url_for('profesor_disponibilidad') }}" class="btn btn-warning btn-sm">Ver Disponibilidad</a>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <i class="fas fa-book fa-2x text-info mb-2"></i>
                                    <h6>Mis Materias</h6>
                                    <p class="small text-muted">Ver materias que tengo asignadas</p>
                                    <a href="{{ url_for('profesor_mis_materias') }}" class="btn btn-info btn-sm">Ver Materias</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if current_user.is_profesor_completo() %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Profesor de Tiempo Completo:</strong> Tienes acceso a funciones adicionales de investigación y gestión académica.
                        </div>
                    {% elif current_user.is_profesor_asignatura() %}
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Profesor por Asignatura:</strong> Tu acceso está limitado a las materias que tienes asignadas.
                        </div>
                    {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para Dibujar Firma - Se crea dinámicamente -->
<div id="modalFirmaContainer"></div>

<script>
// Función para eliminar imagen de perfil
function eliminarImagenPerfil() {
    if (confirm('¿Estás seguro de que quieres eliminar tu imagen de perfil?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/eliminar_imagen_perfil';

        // Agregar token CSRF si es necesario
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// Función para eliminar firma digital
function eliminarFirma() {
    if (confirm('¿Estás seguro de que quieres eliminar tu firma digital?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/eliminar_firma';

        // Agregar token CSRF si es necesario
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// ========== CANVAS PARA DIBUJAR FIRMA (Versión con modal dinámico) ==========
var firmaCanvas = null;
var firmaCtx = null;
var firmaDrawing = false;
var firmaLastX = 0, firmaLastY = 0;
var firmaModal = null;

function abrirModalFirma() {
    // Crear modal HTML dinámicamente
    var modalHTML = `
        <div class="modal fade" id="modalDibujarFirma" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-pen-fancy me-2"></i>Dibujar Mi Firma</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small text-center mb-2">
                            <i class="fas fa-info-circle me-1"></i>Dibuja tu firma con el mouse o dedo
                        </p>
                        <div id="canvasWrapper" class="signature-canvas-wrapper">
                            <canvas id="canvasFirma" class="signature-canvas" draggable="false"></canvas>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <label class="small me-1">Grosor:</label>
                                <input type="range" id="grosorFirma" min="1" max="5" value="2" class="signature-range-control">
                            </div>
                            <div>
                                <label class="small me-1">Color:</label>
                                <input type="color" id="colorFirma" value="#000000" class="signature-color-control">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning btn-sm" id="btnLimpiarFirma">
                            <i class="fas fa-eraser me-1"></i>Borrar
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary btn-sm" id="btnGuardarFirma">
                            <i class="fas fa-save me-1"></i>Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Insertar modal en el body
    var container = document.getElementById('modalFirmaContainer');
    container.innerHTML = modalHTML;

    // Obtener referencia al modal
    var modalEl = document.getElementById('modalDibujarFirma');

    // Configurar canvas cuando el modal esté completamente visible
    modalEl.addEventListener('shown.bs.modal', function() {
        inicializarCanvasFirmaLocal();
    });

    // Limpiar cuando se cierre
    modalEl.addEventListener('hidden.bs.modal', function() {
        container.innerHTML = '';
        firmaCanvas = null;
        firmaCtx = null;
    });

    // Mostrar modal
    firmaModal = new bootstrap.Modal(modalEl);
    firmaModal.show();
}

function inicializarCanvasFirmaLocal() {
    var wrapper = document.getElementById('canvasWrapper');
    firmaCanvas = document.getElementById('canvasFirma');

    // Configurar tamaño
    firmaCanvas.width = wrapper.clientWidth - 16;
    firmaCanvas.height = 150;

    firmaCtx = firmaCanvas.getContext('2d');

    // Fondo blanco
    firmaCtx.fillStyle = '#ffffff';
    firmaCtx.fillRect(0, 0, firmaCanvas.width, firmaCanvas.height);

    // Estilo de línea
    firmaCtx.strokeStyle = '#000000';
    firmaCtx.lineWidth = 2;
    firmaCtx.lineCap = 'round';
    firmaCtx.lineJoin = 'round';

    function obtenerPuntoCanvas(e) {
        var rect = firmaCanvas.getBoundingClientRect();
        return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
        };
    }

    function iniciarDibujo(e) {
        e.preventDefault();
        firmaDrawing = true;
        var punto = obtenerPuntoCanvas(e);
        firmaLastX = punto.x;
        firmaLastY = punto.y;
        if (firmaCanvas.setPointerCapture) {
            firmaCanvas.setPointerCapture(e.pointerId);
        }
    }

    function dibujar(e) {
        if (!firmaDrawing) return;
        e.preventDefault();
        var punto = obtenerPuntoCanvas(e);

        firmaCtx.beginPath();
        firmaCtx.moveTo(firmaLastX, firmaLastY);
        firmaCtx.lineTo(punto.x, punto.y);
        firmaCtx.stroke();

        firmaLastX = punto.x;
        firmaLastY = punto.y;
    }

    function finalizarDibujo(e) {
        if (!firmaDrawing) return;
        e.preventDefault();
        firmaDrawing = false;
        if (firmaCanvas.releasePointerCapture) {
            try {
                firmaCanvas.releasePointerCapture(e.pointerId);
            } catch (error) {
                // Ignorar si el puntero ya no esta capturado
            }
        }
    }

    firmaCanvas.addEventListener('pointerdown', iniciarDibujo);
    firmaCanvas.addEventListener('pointermove', dibujar);
    firmaCanvas.addEventListener('pointerup', finalizarDibujo);
    firmaCanvas.addEventListener('pointercancel', finalizarDibujo);
    window.addEventListener('pointerup', finalizarDibujo);
    firmaCanvas.addEventListener('dragstart', function(e) {
        e.preventDefault();
    });

    // Controles
    document.getElementById('colorFirma').onchange = function() {
        firmaCtx.strokeStyle = this.value;
    };

    document.getElementById('grosorFirma').oninput = function() {
        firmaCtx.lineWidth = this.value;
    };

    // Botones
    document.getElementById('btnLimpiarFirma').onclick = function() {
        firmaCtx.fillStyle = '#ffffff';
        firmaCtx.fillRect(0, 0, firmaCanvas.width, firmaCanvas.height);
        firmaCtx.strokeStyle = document.getElementById('colorFirma').value;
        firmaCtx.lineWidth = document.getElementById('grosorFirma').value;
    };

    document.getElementById('btnGuardarFirma').onclick = function() {
        // Verificar si está vacío
        var imageData = firmaCtx.getImageData(0, 0, firmaCanvas.width, firmaCanvas.height);
        var pixels = imageData.data;
        var isEmpty = true;

        for (var i = 0; i < pixels.length; i += 4) {
            if (pixels[i] !== 255 || pixels[i+1] !== 255 || pixels[i+2] !== 255) {
                isEmpty = false;
                break;
            }
        }

        if (isEmpty) {
            alert('Por favor, dibuja tu firma antes de guardar.');
            return;
        }

        var firmaBase64 = firmaCanvas.toDataURL('image/png');

        fetch('/guardar_firma_dibujada', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ firma: firmaBase64 })
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                firmaModal.hide();
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
            alert('Error al guardar la firma.');
        });
    };
}

// Funciones legacy para compatibilidad (por si se llaman desde otro lugar)
function limpiarCanvasFirma() {
    if (firmaCtx && firmaCanvas) {
        firmaCtx.fillStyle = '#ffffff';
        firmaCtx.fillRect(0, 0, firmaCanvas.width, firmaCanvas.height);
    }
}

function guardarFirmaDibujada() {
    var btn = document.getElementById('btnGuardarFirma');
    if (btn) btn.click();
}
// ========== FIN CANVAS PARA DIBUJAR FIRMA ==========

// Función para previsualizar imagen antes de subir
document.getElementById('imagen_perfil').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // Validar tamaño del archivo (máximo 5MB)
        if (file.size > 5 * 1024 * 1024) {
            alert('El archivo es demasiado grande. Máximo 5MB permitido.');
            e.target.value = '';
            return;
        }
        
        // Validar tipo de archivo
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            alert('Tipo de archivo no permitido. Solo se permiten imágenes (JPG, PNG, GIF).');
            e.target.value = '';
            return;
        }
        
        // Mostrar previsualización
        const reader = new FileReader();
        reader.onload = function(e) {
            // Aquí podríamos mostrar una previsualización, pero por simplicidad
            // solo confirmamos que se va a subir
            console.log('Imagen seleccionada para subir');
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %}