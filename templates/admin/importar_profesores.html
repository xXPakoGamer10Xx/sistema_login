{% extends "base.html" %}

{% block title %}Importar Profesores - Administraci√≥n{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-body">
                <div class="text-center mb-4">
                    <i class="fas fa-upload fa-3x text-success mb-3"></i>
                    <h3 class="card-title">Importar Profesores</h3>
                    <p class="text-muted">Suba un archivo CSV o Excel con la informaci√≥n de los profesores</p>
                </div>

                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-4">
                        {{ form.archivo.label(class="form-label") }}
                        {{ form.archivo(class="form-control") }}
                        {% if form.archivo.errors %}
                            {% for error in form.archivo.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="form-text">
                            Formatos permitidos: CSV, Excel (.xlsx, .xls). Tama√±o m√°ximo: 10MB
                        </div>
                    </div>

                    <div class="mb-4">
                        {{ form.carrera_defecto.label(class="form-label") }}
                        {{ form.carrera_defecto(class="form-select") }}
                        <div class="form-text">
                            Carrera asignada a profesores que no tengan carrera especificada en el archivo
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{{ url_for('gestionar_profesores') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Volver
                        </a>
                        <div>
                            <a href="{{ url_for('descargar_plantilla_csv_profesores') }}" class="btn btn-outline-info me-2" target="_blank">
                                <i class="fas fa-download me-1"></i>
                                Descargar Plantilla
                            </a>
                            {{ form.submit(class="btn btn-success") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Informaci√≥n sobre el formato del archivo -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Formato del Archivo
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Columnas Requeridas</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i><code>nombre</code> - Nombre del usuario</li>
                            <li><i class="fas fa-check text-success me-2"></i><code>apellido_paterno</code> - Apellido paterno</li>
                            <li><i class="fas fa-check text-success me-2"></i><code>apellido_materno</code> - Apellido materno</li>
                            <li><i class="fas fa-check text-success me-2"></i><code>email</code> - Email √∫nico</li>
                            <li><i class="fas fa-check text-success me-2"></i><code>rol</code> - Rol del usuario</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Columnas Opcionales</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-circle text-info me-2"></i><code>telefono</code> - N√∫mero de tel√©fono</li>
                            <li><i class="fas fa-circle text-info me-2"></i><code>tipo_profesor</code> - Solo para profesores</li>
                            <li><i class="fas fa-circle text-info me-2"></i><code>carrera_codigo</code> - C√≥digo de carrera(s)</li>
                        </ul>
                        <div class="alert alert-success mt-2 p-2">
                            <small><strong>üí° M√∫ltiples Carreras:</strong> Separa los c√≥digos con comas sin espacios: <code>IRO,ISC,IND</code></small>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Valores para rol:</h6>
                    <ul class="mb-0">
                        <li><code>admin</code> - Administrador del sistema</li>
                        <li><code>jefe_carrera</code> - Jefe de carrera (debe especificar UNA carrera)</li>
                        <li><code>profesor</code> o <code>profesor_completo</code> o <code>tiempo completo</code> - Profesor de tiempo completo</li>
                        <li><code>profesor_asignatura</code> o <code>asignatura</code> - Profesor por asignatura</li>
                    </ul>
                </div>

                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-graduation-cap me-2"></i>C√≥digos de Carreras Disponibles:</h6>
                    <div class="row">
                        {% for carrera in carreras %}
                            <div class="col-md-6">
                                <code>{{ carrera.codigo }}</code> - {{ carrera.nombre }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Ejemplo de archivo -->
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-file-csv me-2"></i>
                    Ejemplo de Archivo CSV
                </h6>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded">
nombre,apellido_paterno,apellido_materno,email,telefono,rol,tipo_profesor,carrera_codigo
Juan,P√©rez,Garc√≠a,juan.perez@universidad.edu,555-1234,profesor,profesor_completo,IRO
Mar√≠a,Gonz√°lez,L√≥pez,maria.gonzalez@universidad.edu,555-5678,profesor,profesor_asignatura,IRO,ISC
Carlos,Rodr√≠guez,Mart√≠nez,carlos.rodriguez@universidad.edu,555-9012,jefe_carrera,,IRO
Ana,L√≥pez,Hern√°ndez,ana.lopez@universidad.edu,,profesor,asignatura,IRO,ISC,IND
Pedro,S√°nchez,Ram√≠rez,pedro.sanchez@universidad.edu,555-3456,admin,,</pre>
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Nota:</strong> 
                        - Juan es profesor de tiempo completo en IRO<br>
                        - Mar√≠a es profesora por asignatura en IRO e ISC<br>
                        - Carlos es jefe de carrera de IRO<br>
                        - Ana es profesora por asignatura en IRO, ISC e IND<br>
                        - Pedro es administrador (sin carrera asignada)
                    </small>
                </div>
            </div>
        </div>

        <!-- Notas importantes -->
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Notas Importantes
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><i class="fas fa-key text-warning me-2"></i>Se generar√° autom√°ticamente un <strong>username</strong> √∫nico basado en nombre.apellido_paterno</li>
                    <li class="mb-2"><i class="fas fa-lock text-success me-2"></i>Se generar√° una <strong>contrase√±a temporal aleatoria</strong> de 8 caracteres para cada usuario nuevo</li>
                    <li class="mb-2"><i class="fas fa-shield-alt text-info me-2"></i>Los usuarios nuevos <strong>deber√°n cambiar su contrase√±a</strong> en el primer inicio de sesi√≥n</li>
                    <li class="mb-2"><i class="fas fa-envelope text-warning me-2"></i>Los emails deben ser <strong>√∫nicos</strong> en el sistema</li>
                    <li class="mb-2"><i class="fas fa-graduation-cap text-warning me-2"></i>Si no se especifica carrera_codigo, se usar√° la carrera por defecto seleccionada arriba</li>
                    <li class="mb-2"><i class="fas fa-users text-success me-2"></i><strong>‚ú® M√∫ltiples Carreras:</strong> Un profesor puede estar en varias carreras separando los c√≥digos con comas <strong>sin espacios</strong> (ej: <code>IRO,ISC,IND</code>)</li>
                    <li class="mb-2"><i class="fas fa-user-shield text-primary me-2"></i><strong>Jefe de Carrera:</strong> Debe especificar exactamente UNA carrera en carrera_codigo</li>
                    <li class="mb-2"><i class="fas fa-user-cog text-danger me-2"></i><strong>Administrador:</strong> No requiere carrera_codigo ni tipo_profesor</li>
                    <li class="mb-2"><i class="fas fa-sync-alt text-info me-2"></i>Si el email ya existe, se <strong>actualizar√°n</strong> los datos del usuario existente (sin cambiar su contrase√±a)</li>
                </ul>
            </div>
        </div>

        <!-- Tutorial de M√∫ltiples Carreras -->
        <div class="card mt-4 border-success">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    ‚ú® C√≥mo Asignar M√∫ltiples Carreras a un Profesor
                </h6>
            </div>
            <div class="card-body">
                <p class="mb-3">Para asignar un profesor a varias carreras, sigue estos pasos:</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="alert alert-light border">
                            <h6 class="text-success"><i class="fas fa-check-circle me-2"></i>Formato Correcto ‚úÖ</h6>
                            <code class="d-block bg-white p-2 rounded">IRO,ISC,IND</code>
                            <small class="text-muted">Sin espacios entre las comas</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-light border">
                            <h6 class="text-danger"><i class="fas fa-times-circle me-2"></i>Formato Incorrecto ‚ùå</h6>
                            <code class="d-block bg-white p-2 rounded">IRO, ISC, IND</code>
                            <small class="text-muted">Con espacios (causar√° errores)</small>
                        </div>
                    </div>
                </div>

                <div class="mt-3 p-3 bg-light rounded">
                    <h6><i class="fas fa-lightbulb text-warning me-2"></i>Ejemplos Pr√°cticos:</h6>
                    <table class="table table-sm table-bordered bg-white">
                        <thead class="table-success">
                            <tr>
                                <th>Caso</th>
                                <th>Valor en carrera_codigo</th>
                                <th>Resultado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Una carrera</td>
                                <td><code>IRO</code></td>
                                <td>Profesor asignado solo a Ingenier√≠a</td>
                            </tr>
                            <tr>
                                <td>Dos carreras</td>
                                <td><code>IRO,ISC</code></td>
                                <td>Profesor asignado a Ingenier√≠a y Sistemas</td>
                            </tr>
                            <tr>
                                <td>Tres carreras</td>
                                <td><code>IRO,ISC,IND</code></td>
                                <td>Profesor en Ingenier√≠a, Sistemas e Industrial</td>
                            </tr>
                            <tr>
                                <td>Sin especificar</td>
                                <td><em>(vac√≠o)</em></td>
                                <td>Se usa la carrera por defecto del formulario</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Tip:</strong> Puedes mezclar profesores con una sola carrera y profesores con m√∫ltiples carreras en el mismo archivo CSV.
                </div>
            </div>
        </div>

        <!-- Mostrar contrase√±as generadas si hubo usuarios creados -->
        {% if mostrar_passwords and resultado and resultado.usuarios_creados %}
        <div class="card mt-4 border-success shadow-lg">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i>
                    Contrase√±as Temporales Generadas
                </h5>
                <small>‚ö†Ô∏è IMPORTANTE: Guarde esta informaci√≥n de forma segura. Las contrase√±as NO se mostrar√°n nuevamente.</small>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Instrucciones:</strong>
                    <ul class="mb-0">
                        <li>Copie y guarde estas contrase√±as en un lugar seguro</li>
                        <li>Entregue a cada usuario su contrase√±a temporal</li>
                        <li>Los usuarios deber√°n cambiar su contrase√±a en el primer inicio de sesi√≥n</li>
                    </ul>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-success">
                            <tr>
                                <th>Nombre Completo</th>
                                <th>Usuario (Username)</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Contrase√±a Temporal</th>
                                <th>Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for usuario in resultado.usuarios_creados %}
                            <tr>
                                <td>{{ usuario.nombre }}</td>
                                <td><code>{{ usuario.username }}</code></td>
                                <td>{{ usuario.email }}</td>
                                <td>
                                    {% if usuario.rol == 'admin' %}
                                        <span class="badge bg-danger">Administrador</span>
                                    {% elif usuario.rol == 'jefe_carrera' %}
                                        <span class="badge bg-primary">Jefe de Carrera</span>
                                    {% elif usuario.rol == 'profesor_completo' %}
                                        <span class="badge bg-success">Profesor T. Completo</span>
                                    {% elif usuario.rol == 'profesor_asignatura' %}
                                        <span class="badge bg-info">Profesor Asignatura</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ usuario.rol }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <code class="fs-5 text-danger" id="password-{{ loop.index }}">{{ usuario.password }}</code>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="copiarPassword('{{ usuario.password }}', {{ loop.index }})">
                                        <i class="fas fa-copy me-1"></i>Copiar
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Formato de entrega sugerido:</strong><br>
                    <code>
                        Usuario: [username]<br>
                        Contrase√±a temporal: [password]<br>
                        Deber√°s cambiar tu contrase√±a en el primer inicio de sesi√≥n.
                    </code>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                    <button class="btn btn-success" onclick="copiarTodasPasswords()">
                        <i class="fas fa-copy me-1"></i>Copiar Todas las Contrase√±as
                    </button>
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                </div>
            </div>
        </div>

        <script>
        function copiarPassword(password, index) {
            navigator.clipboard.writeText(password).then(function() {
                // Cambiar temporalmente el bot√≥n
                const btn = event.target.closest('button');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>¬°Copiado!';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                
                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-secondary');
                }, 2000);
            }).catch(function(err) {
                alert('Error al copiar: ' + err);
            });
        }

        function copiarTodasPasswords() {
            let texto = "CONTRASE√ëAS TEMPORALES - {{ resultado.usuarios_creados|length }} USUARIOS\n\n";
            {% for usuario in resultado.usuarios_creados %}
            texto += "{{ loop.index }}. {{ usuario.nombre }}\n";
            texto += "   Usuario: {{ usuario.username }}\n";
            texto += "   Email: {{ usuario.email }}\n";
            texto += "   Contrase√±a: {{ usuario.password }}\n";
            texto += "   Rol: {{ usuario.rol }}\n\n";
            {% endfor %}
            
            navigator.clipboard.writeText(texto).then(function() {
                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-1"></i>¬°Todas Copiadas!';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-primary');
                
                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                }, 3000);
            }).catch(function(err) {
                alert('Error al copiar: ' + err);
            });
        }
        </script>
        {% endif %}
    </div>
</div>
{% endblock %}