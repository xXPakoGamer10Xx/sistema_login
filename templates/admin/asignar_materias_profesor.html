{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4 mb-5">
    
    <!-- Encabezado Gradient Prominente -->
    <div class="card border-0 shadow-sm mb-4 overflow-hidden">
        <div class="card-header py-4 position-relative" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="d-flex justify-content-between align-items-center position-relative" style="z-index: 2;">
                <div class="d-flex align-items-center text-white">
                    <div class="bg-white bg-opacity-25 rounded-circle p-3 me-3 d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                        <i class="fas fa-chalkboard-teacher fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-uppercase text-white-50 mb-1 ls-1" style="letter-spacing: 2px; font-size: 0.75rem;">Asignación de Materias</h6>
                        <h2 class="mb-0 fw-bold">{{ profesor.nombre }} {{ profesor.apellido }}</h2>
                        <div class="mt-2">
                             <span class="badge bg-white text-primary bg-opacity-90 rounded-pill px-3 py-1">
                                <i class="fas fa-id-badge me-1"></i> {{ profesor.get_rol_display() }}
                            </span>
                        </div>
                    </div>
                </div>
                <div>
                     <a href="{{ url_for('gestionar_profesores') }}" class="btn btn-white bg-white text-primary shadow-sm fw-bold rounded-pill px-4">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
            <!-- Elemento decorativo de fondo -->
            <div class="position-absolute bottom-0 end-0 opacity-10 me-5 mb-n4" style="transform: rotate(15deg);">
               <i class="fas fa-book-open fa-10x text-white"></i>
            </div>
        </div>
    </div>

    <!-- Barra de Herramientas y Filtros -->
    <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 10px; z-index: 900; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);">
        <div class="card-body py-3">
            <div class="row g-3 align-items-center">
                <!-- Filtro Carrera -->
                <div class="col-md-auto">
                    <label class="d-block text-uppercase text-muted fw-bold mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">Carrera</label>
                    <div class="btn-group shadow-sm" role="group" id="filtro-carreras">
                        <button type="button" class="btn btn-sm btn-outline-primary active fw-bold px-3 rounded-start-pill" data-carrera="todas" onclick="filtrar('carrera', 'todas')">
                            Todas
                        </button>
                        {% for carrera in profesor.carreras %}
                        <button type="button" class="btn btn-sm btn-outline-primary fw-bold px-3" 
                                data-carrera="{{ carrera.codigo }}" 
                                onclick="filtrar('carrera', '{{ carrera.codigo }}')">
                            {{ carrera.codigo }}
                        </button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Filtro Cuatrimestre -->
                <div class="col-md border-start border-light ps-md-3">
                    <label class="d-block text-uppercase text-muted fw-bold mb-1" style="font-size: 0.65rem; letter-spacing: 1px;">Cuatrimestres</label>
                    <div class="d-flex gap-1 flex-wrap" id="filtro-cuatris">
                        <button type="button" class="btn btn-xs btn-outline-secondary active rounded-pill px-2" data-cuatri="todos" onclick="filtrar('cuatrimestre', 'todos')">All</button>
                        {% for i in range(0, 11) %}
                        <button type="button" class="btn btn-xs btn-outline-secondary rounded-pill px-2" style="width: 28px;" data-cuatri="{{ i }}" onclick="filtrar('cuatrimestre', '{{ i }}')">{{ i }}</button>
                        {% endfor %}
                    </div>
                </div>

                <!-- Buscador -->
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0 ps-3 rounded-start-pill text-muted">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control bg-light border-start-0 ps-0 rounded-end-pill" id="buscar-materia" 
                               placeholder="Buscar materia..." onkeyup="filtrar('texto')">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor Principal de Materias -->
    <form method="POST" action="" id="form-asignar-materias">
        {{ form.hidden_tag() }}
        
        <div id="materias-container">
            <!-- Renderizado JS -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Barra Flotante de Acción Inferior -->
<div class="fixed-bottom p-3 d-flex justify-content-center" style="pointer-events: none; z-index: 1050;">
    <div class="bg-dark text-white shadow-lg rounded-pill px-4 py-2 d-flex align-items-center gap-4" style="pointer-events: auto; backdrop-filter: blur(5px); background-color: rgba(33, 37, 41, 0.95) !important;">
        <div class="d-flex align-items-center border-end border-secondary pe-4">
            <div class="position-relative me-2">
                <i class="fas fa-book fa-lg text-warning"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="footer-badge-count" style="font-size: 0.5rem; display: none;">0</span>
            </div>
            <div>
                <span class="h4 mb-0 fw-bold" id="footer-count">0</span>
                <small class="text-white-50 ms-1">seleccionadas</small>
            </div>
        </div>
        
        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="seleccionarVisibles(true)">
                <i class="fas fa-check-double me-1"></i> Todo
            </button>
            <button type="button" class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="seleccionarVisibles(false)">
                <i class="fas fa-times me-1"></i> Nada
            </button>
            <button type="submit" form="form-asignar-materias" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm ms-2">
                <i class="fas fa-save me-2"></i> Guardar Cambios
            </button>
        </div>
    </div>
</div>

<style>
    /* Estilos Personalizados */
    .btn-xs {
        padding: 0.15rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .cursor-pointer { cursor: pointer; }
    
    /* Animaciones suaves */
    .carrera-section, .cuatri-card, .materia-row {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    /* Materia Item Styling */
    .materia-check-input {
        display: none; /* Ocultar el checkbox nativo */
    }
    
    .materia-card {
        border: 1px solid #e9ecef;
        background: #fff;
        border-radius: 8px;
        padding: 10px 15px;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }
    
    .materia-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border-color: #cbd3da;
    }
    
    /* Estado Seleccionado */
    .materia-check-input:checked + .materia-card {
        background-color: #eef2ff;
        border-color: #667eea;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.15);
    }
    
    .materia-check-input:checked + .materia-card .materia-icon {
        color: #667eea;
        transform: scale(1.1);
    }
    
    .materia-check-input:checked + .materia-card .check-indicator {
        opacity: 1;
        transform: scale(1);
    }
    
    .materia-icon {
        transition: transform 0.2s ease;
        color: #adb5bd;
    }
    
    .check-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        color: #667eea;
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .item-hidden {
        display: none !important;
    }
    
    /* Bordes de colores por carrera */
    .border-left-accent {
        border-left: 4px solid;
    }
</style>

<script>
// Data from server
// eslint-disable-next-line
const materiasDisponibles = {{ form.materias.choices | tojson }};
// eslint-disable-next-line
const materiasAsignadas = {{ form.materias.data | tojson }};
// eslint-disable-next-line
const carrerasProfesor = {{ profesor.carreras | map(attribute='codigo') | list | tojson }};

// Color mapping
const coloresCarrera = {};
const palette = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
carrerasProfesor.forEach((codigo, index) => {
    coloresCarrera[codigo] = palette[index % palette.length];
});

// State
let estadoFiltros = {
    carrera: 'todas',
    cuatrimestre: 'todos',
    texto: ''
};

document.addEventListener('DOMContentLoaded', function() {
    renderizarUI();
    actualizarFooter();
});

function renderizarUI() {
    const container = document.getElementById('materias-container');
    container.innerHTML = '';
    
    // Organizar datos
    const estructura = {};
    
    materiasDisponibles.forEach(([id, texto]) => {
        const matchCarrera = texto.match(/\(([^)]+)\)$/);
        const matchCuatri = texto.match(/Cuatri (\d+)/);
        
        const carrera = matchCarrera ? matchCarrera[1] : 'General';
        const cuatrimestre = matchCuatri ? parseInt(matchCuatri[1]) : 0;
        
        if (!estructura[carrera]) estructura[carrera] = {};
        if (!estructura[carrera][cuatrimestre]) estructura[carrera][cuatrimestre] = [];
        
        const nombreLimpio = texto.replace(/^Cuatri \d+ - /, '').replace(/\([^)]+\)$/, '').trim();
        const codigoMateria = nombreLimpio.split(':')[0].trim();
        const nombreMateria = nombreLimpio.split(':').slice(1).join(':').trim() || nombreLimpio;
        
        estructura[carrera][cuatrimestre].push({
            id: id,
            codigo: codigoMateria,
            nombre: nombreMateria,
            textoCompleto: texto.toLowerCase(),
            checked: materiasAsignadas.includes(id)
        });
    });

    const carrerasOrdenadas = Object.keys(estructura).sort();
    
    if (carrerasOrdenadas.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-inbox fa-3x mb-3 opacity-50"></i>
                <p class="lead">No hay materias disponibles para asignar.</p>
            </div>
        `;
        return;
    }

    carrerasOrdenadas.forEach((carrera) => {
        const colorCarrera = coloresCarrera[carrera] || '#6c757d';
        
        const carreraDiv = document.createElement('div');
        carreraDiv.className = 'carrera-section mb-5';
        carreraDiv.setAttribute('data-carrera', carrera);
        
        // Header de Carrera Moderno con línea
        carreraDiv.innerHTML = `
            <div class="d-flex align-items-center mb-4">
                <span class="badge rounded-pill me-3 shadow-sm px-3 py-2" style="background-color: ${colorCarrera}; font-size: 1rem;">${carrera}</span>
                <div class="flex-grow-1 border-bottom"></div>
            </div>
        `;
        
        const cuatrisContainer = document.createElement('div');
        cuatrisContainer.className = 'row g-4'; 
        
        const cuatrosOrdenados = Object.keys(estructura[carrera]).sort((a,b) => a-b);
        
        cuatrosOrdenados.forEach(cuatri => {
            const materias = estructura[carrera][cuatri];
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-6 col-lg-4 cuatri-wrapper';
            colDiv.setAttribute('data-cuatri', cuatri);
            
            let materiasHTML = '';
            materias.forEach(m => {
                materiasHTML += `
                    <div class="materia-item mb-2" data-texto="${m.textoCompleto}">
                        <input class="materia-check-input" type="checkbox" name="materias" 
                               value="${m.id}" id="m-${m.id}" 
                               ${m.checked ? 'checked' : ''} 
                               onchange="actualizarFooter()">
                        
                        <label class="materia-card d-flex align-items-center w-100" for="m-${m.id}">
                            <div class="materia-icon me-3">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="flex-grow-1" style="min-width: 0;">
                                <div class="fw-bold text-dark text-truncate" style="font-size: 0.85rem;">${m.codigo}</div>
                                <div class="text-muted text-truncate small" title="${m.nombre}">${m.nombre}</div>
                            </div>
                            <div class="check-indicator">
                                <i class="fas fa-check-circle fa-lg"></i>
                            </div>
                        </label>
                    </div>
                `;
            });
            
            colDiv.innerHTML = `
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-header bg-white border-bottom-0 pt-3 pb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="text-uppercase text-muted fw-bold mb-0 small ls-1">Cuatrimestre ${cuatri}</h6>
                            <span class="badge bg-light text-dark rounded-pill">${materias.length}</span>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        ${materiasHTML}
                    </div>
                </div>
            `;
            
            cuatrisContainer.appendChild(colDiv);
        });
        
        carreraDiv.appendChild(cuatrisContainer);
        container.appendChild(carreraDiv);
    });
}

function filtrar(tipo, valor) {
    if (tipo === 'carrera') estadoFiltros.carrera = valor;
    if (tipo === 'cuatrimestre') estadoFiltros.cuatrimestre = valor;
    if (tipo === 'texto') estadoFiltros.texto = document.getElementById('buscar-materia').value.toLowerCase();
    
    // Update UI Buttons
    if (tipo === 'carrera') {
        document.querySelectorAll('#filtro-carreras button').forEach(b => {
             // Reset classes
             b.className = 'btn btn-sm btn-outline-primary fw-bold px-3';
             if(b.getAttribute('data-carrera') === valor) {
                 b.classList.add('active');
             }
        });
        // Rounded fix for first button
        document.querySelector('#filtro-carreras button:first-child').classList.add('rounded-start-pill');
    }
    
    if (tipo === 'cuatrimestre') {
        document.querySelectorAll('#filtro-cuatris button').forEach(b => {
            b.classList.remove('active', 'btn-secondary');
            b.classList.add('btn-outline-secondary');
            
            if(b.getAttribute('data-cuatri') === valor) {
                b.classList.remove('btn-outline-secondary');
                b.classList.add('active', 'btn-secondary');
            }
        });
    }
    
    aplicarFiltrosDOM();
}

function aplicarFiltrosDOM() {
    document.querySelectorAll('.carrera-section').forEach(section => {
        const carrera = section.getAttribute('data-carrera');
        const visiblePorCarrera = (estadoFiltros.carrera === 'todas' || estadoFiltros.carrera === carrera);
        
        if (!visiblePorCarrera) {
            section.classList.add('item-hidden');
            return;
        }
        
        let tieneCuatrisVisibles = false;
        
        section.querySelectorAll('.cuatri-wrapper').forEach(cuatriBlock => {
            const cuatri = cuatriBlock.getAttribute('data-cuatri');
            const visiblePorCuatri = (estadoFiltros.cuatrimestre === 'todos' || estadoFiltros.cuatrimestre === cuatri);
            
            if (!visiblePorCuatri) {
                cuatriBlock.classList.add('item-hidden');
                return;
            }
            
            let tieneMateriasVisibles = false;
            
            cuatriBlock.querySelectorAll('.materia-item').forEach(item => {
                const texto = item.getAttribute('data-texto');
                const visiblePorTexto = texto.includes(estadoFiltros.texto);
                
                if (visiblePorTexto) {
                    item.classList.remove('item-hidden');
                    tieneMateriasVisibles = true;
                } else {
                    item.classList.add('item-hidden');
                }
            });
            
            if (tieneMateriasVisibles) {
                cuatriBlock.classList.remove('item-hidden');
                tieneCuatrisVisibles = true;
            } else {
                cuatriBlock.classList.add('item-hidden');
            }
        });
        
        if (tieneCuatrisVisibles) {
            section.classList.remove('item-hidden');
        } else {
            section.classList.add('item-hidden');
        }
    });
}

function seleccionarVisibles(seleccionar) {
    const inputs = document.querySelectorAll('input[name="materias"]');
    inputs.forEach(input => {
        const item = input.closest('.materia-item');
        const cuatri = input.closest('.cuatri-wrapper');
        const carrera = input.closest('.carrera-section');
        
        // Verifica si el elemento y sus padres están visibles (no tienen 'item-hidden')
        if (!item.classList.contains('item-hidden') && 
            !cuatri.classList.contains('item-hidden') && 
            !carrera.classList.contains('item-hidden')) {
            input.checked = seleccionar;
        }
    });
    actualizarFooter();
}

function actualizarFooter() {
    const count = document.querySelectorAll('input[name="materias"]:checked').length;
    const counterElement = document.getElementById('footer-count');
    const badgeElement = document.getElementById('footer-badge-count');
    
    // Animación simple de conteo
    counterElement.style.transform = 'scale(1.2)';
    setTimeout(() => counterElement.style.transform = 'scale(1)', 150);
    
    counterElement.textContent = count;
    
    if (count > 0) {
        badgeElement.textContent = count;
        badgeElement.style.display = 'block';
    } else {
        badgeElement.style.display = 'none';
    }
}
</script>
{% endblock %}
